name: EAS Staging Build
on:
    workflow_dispatch:
        inputs:
            profile:
                description: "Profile"
                required: true
                default: "staging"
                type: choice
                options:
                    - development
                    - internal
                    - staging
            platform:
                description: "Platform"
                required: true
                default: "all"
                type: choice
                options:
                    - all
                    - android
                    - ios
    push:
        tags:
            - "v*.*.*-rc.*"
jobs:
    build:
        name: Install and build
        runs-on: ubuntu-latest
        steps:
            - name: Set inputs or fallbacks
              run: |
                  echo "PLATFORM=${{ github.event.inputs.platform || 'all' }}" >> $GITHUB_ENV
                  PROFILE="${{ github.event.inputs.profile || 'staging' }}"
                  echo "PROFILE=$PROFILE" >> $GITHUB_ENV
                  if [ "$PROFILE" == "staging" ]; then
                    echo "AUTO_SUBMIT=--auto-submit" >> $GITHUB_ENV
                  else
                    echo "AUTO_SUBMIT=" >> $GITHUB_ENV
                  fi

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Important to fetch tags, which are used in app.config.js

            - uses: actions/setup-node@v4
              with:
                  node-version-file: ".nvmrc"
                  cache: yarn

            - name: Setup Expo and EAS
              uses: expo/expo-github-action@v8
              with:
                  eas-version: latest
                  token: ${{ secrets.EXPO_TOKEN }}

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Get git commit hash
              run: echo "GIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

            - name: Build on EAS
              run: eas build --profile $PROFILE --platform $PLATFORM $AUTO_SUBMIT --non-interactive --no-wait
              env:
                  EXPO_PUBLIC_GIT_HASH: ${{ env.GIT_HASH }}
