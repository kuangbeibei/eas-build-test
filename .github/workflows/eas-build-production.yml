name: EAS Production Build
on:
    workflow_dispatch:
        inputs:
            platform:
                description: "Platform"
                required: true
                default: "all"
                type: choice
                options:
                    - all
                    - android
                    - ios
    push:
        tags:
            - "v*.*.*"
            - "!v*.*.*-rc.*"
            - "!v*.*.*-ota.*"
jobs:
    build:
        name: Install and build
        runs-on: ubuntu-latest
        steps:
            - name: Set inputs or fallbacks
              run: |
                  echo "PLATFORM=${{ github.event.inputs.platform || 'all' }}" >> $GITHUB_ENV

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Important to fetch tags, which are used in app.config.js

            - uses: actions/setup-node@v4
              with:
                  node-version-file: ".nvmrc"
                  cache: yarn

            - name: Setup Expo and EAS
              uses: expo/expo-github-action@v8
              with:
                  eas-version: latest
                  token: ${{ secrets.EXPO_TOKEN }}

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build on EAS
              run: eas build --profile production --platform $PLATFORM --auto-submit --non-interactive --no-wait
